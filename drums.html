<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drum Machine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 30px;
        }

        .main-container {
            background: rgba(20, 20, 35, 0.9);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 1200px;
            width: 100%;
        }

        .controls-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .transport {
            display: flex;
            gap: 10px;
        }

        .transport button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #playBtn {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #000;
        }

        #playBtn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        #playBtn.playing {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
        }

        #stopBtn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #stopBtn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }

        .tempo-display {
            font-size: 32px;
            font-weight: bold;
            font-family: monospace;
            color: #feca57;
            min-width: 80px;
        }

        .tempo-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
        }

        .tempo-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .tempo-btn {
            width: 30px;
            height: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .tempo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        input[type="range"] {
            -webkit-appearance: none;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #feca57;
            border-radius: 50%;
            cursor: pointer;
        }

        .swing-control, .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px 15px;
            border-radius: 10px;
        }

        .control-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
        }

        .control-value {
            font-family: monospace;
            color: #48dbfb;
            min-width: 40px;
        }

        .kit-selector {
            display: flex;
            gap: 8px;
        }

        .kit-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .kit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .kit-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-color: transparent;
        }

        .sequencer {
            margin-top: 20px;
        }

        .track {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }

        .track-info {
            width: 120px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-right: 15px;
        }

        .track-name {
            font-size: 13px;
            font-weight: 500;
            flex: 1;
        }

        .track-controls {
            display: flex;
            gap: 5px;
        }

        .track-btn {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .mute-btn {
            background: rgba(255, 100, 100, 0.2);
            color: #ff6b6b;
        }

        .mute-btn.active {
            background: #ff6b6b;
            color: #000;
        }

        .solo-btn {
            background: rgba(100, 255, 100, 0.2);
            color: #00ff88;
        }

        .solo-btn.active {
            background: #00ff88;
            color: #000;
        }

        .steps {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .step {
            flex: 1;
            height: 40px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
            position: relative;
        }

        .step:nth-child(4n+1) {
            background: rgba(255, 255, 255, 0.08);
        }

        .step:nth-child(4n+2),
        .step:nth-child(4n+3),
        .step:nth-child(4n) {
            background: rgba(255, 255, 255, 0.04);
        }

        .step:hover {
            filter: brightness(1.3);
        }

        .step.active {
            background: var(--track-color);
            box-shadow: 0 0 15px var(--track-color);
        }

        .step.current {
            box-shadow: inset 0 0 0 2px #fff;
        }

        .step.velocity-low.active { opacity: 0.5; }
        .step.velocity-med.active { opacity: 0.75; }
        .step.velocity-high.active { opacity: 1; }

        .pattern-bar {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-wrap: wrap;
        }

        .pattern-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        .pattern-btn {
            width: 40px;
            height: 40px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .pattern-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .pattern-btn.active {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            border-color: transparent;
            color: #000;
        }

        .pattern-btn.has-data::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 6px;
            height: 6px;
            background: #00ff88;
            border-radius: 50%;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .action-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .pads-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pads-header {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .pads {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            max-width: 400px;
        }

        .pad {
            aspect-ratio: 1;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            color: #fff;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .pad:active, .pad.playing {
            transform: scale(0.95);
            filter: brightness(1.5);
        }

        .pad .key {
            font-size: 10px;
            opacity: 0.5;
        }

        .visualizer {
            height: 60px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        .visualizer canvas {
            width: 100%;
            height: 100%;
        }

        @media (max-width: 768px) {
            .controls-row {
                justify-content: center;
            }

            .track-info {
                width: 80px;
            }

            .track-name {
                font-size: 11px;
            }

            .step {
                height: 30px;
            }

            .pads {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Drum Machine</h1>
    <p class="subtitle">Step Sequencer & Beat Maker</p>

    <div class="main-container">
        <div class="controls-row">
            <div class="transport">
                <button id="playBtn" title="Play/Pause">&#9658;</button>
                <button id="stopBtn" title="Stop">&#9632;</button>
            </div>

            <div class="tempo-control">
                <div>
                    <div class="tempo-display" id="tempoDisplay">120</div>
                    <div class="tempo-label">BPM</div>
                </div>
                <input type="range" id="tempoSlider" min="60" max="200" value="120" style="width: 150px;">
                <div class="tempo-buttons">
                    <button class="tempo-btn" id="tempoUp">+</button>
                    <button class="tempo-btn" id="tempoDown">-</button>
                </div>
            </div>

            <div class="swing-control">
                <span class="control-label">Swing</span>
                <input type="range" id="swingSlider" min="0" max="100" value="0" style="width: 80px;">
                <span class="control-value" id="swingValue">0%</span>
            </div>

            <div class="volume-control">
                <span class="control-label">Vol</span>
                <input type="range" id="volumeSlider" min="0" max="100" value="80" style="width: 80px;">
                <span class="control-value" id="volumeValue">80%</span>
            </div>

            <div class="kit-selector">
                <button class="kit-btn active" data-kit="808">808</button>
                <button class="kit-btn" data-kit="acoustic">Acoustic</button>
                <button class="kit-btn" data-kit="electronic">Electronic</button>
            </div>
        </div>

        <div class="sequencer" id="sequencer"></div>

        <div class="pattern-bar">
            <span class="pattern-label">Patterns:</span>
            <button class="pattern-btn active" data-pattern="0">1</button>
            <button class="pattern-btn" data-pattern="1">2</button>
            <button class="pattern-btn" data-pattern="2">3</button>
            <button class="pattern-btn" data-pattern="3">4</button>
            <button class="pattern-btn" data-pattern="4">5</button>
            <button class="pattern-btn" data-pattern="5">6</button>
            <button class="pattern-btn" data-pattern="6">7</button>
            <button class="pattern-btn" data-pattern="7">8</button>

            <div class="action-buttons">
                <button class="action-btn" id="clearPattern">Clear</button>
                <button class="action-btn" id="copyPattern">Copy</button>
                <button class="action-btn" id="pastePattern">Paste</button>
                <button class="action-btn" id="randomPattern">Random</button>
            </div>
        </div>

        <div class="pads-section">
            <div class="pads-header">Drum Pads (Use keyboard 1-8)</div>
            <div class="pads" id="pads"></div>
        </div>

        <div class="visualizer">
            <canvas id="visualizer"></canvas>
        </div>
    </div>

    <script>
        // Audio Context
        let audioCtx;
        let masterGain;
        let analyser;
        let isPlaying = false;
        let currentStep = 0;
        let tempo = 120;
        let swing = 0;
        let volume = 0.8;
        let schedulerTimer;
        let nextNoteTime = 0;
        let currentPattern = 0;
        let copiedPattern = null;

        const STEPS = 16;
        const LOOKAHEAD = 25; // ms
        const SCHEDULE_AHEAD = 0.1; // seconds

        // Track definitions
        const tracks = [
            { name: 'Kick', color: '#ff6b6b', key: '1' },
            { name: 'Snare', color: '#feca57', key: '2' },
            { name: 'Hi-Hat', color: '#48dbfb', key: '3' },
            { name: 'Open HH', color: '#00d2d3', key: '4' },
            { name: 'Clap', color: '#ff9ff3', key: '5' },
            { name: 'Tom', color: '#54a0ff', key: '6' },
            { name: 'Rim', color: '#5f27cd', key: '7' },
            { name: 'Cymbal', color: '#c8d6e5', key: '8' }
        ];

        // Pattern storage (8 patterns)
        let patterns = Array(8).fill(null).map(() =>
            tracks.map(() => Array(STEPS).fill(0))
        );

        // Track states
        let muted = tracks.map(() => false);
        let soloed = tracks.map(() => false);

        // Current kit
        let currentKit = '808';

        // Initialize audio
        function initAudio() {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            masterGain = audioCtx.createGain();
            masterGain.gain.value = volume;

            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;

            masterGain.connect(analyser);
            analyser.connect(audioCtx.destination);
        }

        // Sound synthesis
        function playSound(trackIndex, time, velocity = 1) {
            if (!audioCtx) initAudio();

            const track = tracks[trackIndex];
            const gain = audioCtx.createGain();
            gain.connect(masterGain);

            switch(trackIndex) {
                case 0: // Kick
                    playKick(time, gain, velocity);
                    break;
                case 1: // Snare
                    playSnare(time, gain, velocity);
                    break;
                case 2: // Hi-Hat closed
                    playHiHat(time, gain, velocity, false);
                    break;
                case 3: // Hi-Hat open
                    playHiHat(time, gain, velocity, true);
                    break;
                case 4: // Clap
                    playClap(time, gain, velocity);
                    break;
                case 5: // Tom
                    playTom(time, gain, velocity);
                    break;
                case 6: // Rim
                    playRim(time, gain, velocity);
                    break;
                case 7: // Cymbal
                    playCymbal(time, gain, velocity);
                    break;
            }
        }

        function playKick(time, output, velocity) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(150, time);
            osc.frequency.exponentialRampToValueAtTime(40, time + 0.1);

            gain.gain.setValueAtTime(velocity * 1.2, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.4);

            osc.connect(gain);
            gain.connect(output);

            osc.start(time);
            osc.stop(time + 0.4);

            // Click for attack
            const click = audioCtx.createOscillator();
            const clickGain = audioCtx.createGain();
            click.type = 'square';
            click.frequency.setValueAtTime(200, time);
            clickGain.gain.setValueAtTime(velocity * 0.3, time);
            clickGain.gain.exponentialRampToValueAtTime(0.001, time + 0.02);
            click.connect(clickGain);
            clickGain.connect(output);
            click.start(time);
            click.stop(time + 0.02);
        }

        function playSnare(time, output, velocity) {
            // Body
            const osc = audioCtx.createOscillator();
            const oscGain = audioCtx.createGain();
            osc.type = 'triangle';
            osc.frequency.setValueAtTime(180, time);
            osc.frequency.exponentialRampToValueAtTime(100, time + 0.1);
            oscGain.gain.setValueAtTime(velocity * 0.5, time);
            oscGain.gain.exponentialRampToValueAtTime(0.001, time + 0.15);
            osc.connect(oscGain);
            oscGain.connect(output);
            osc.start(time);
            osc.stop(time + 0.15);

            // Noise
            const noise = createNoise(0.2);
            const noiseFilter = audioCtx.createBiquadFilter();
            noiseFilter.type = 'highpass';
            noiseFilter.frequency.value = 1000;
            const noiseGain = audioCtx.createGain();
            noiseGain.gain.setValueAtTime(velocity * 0.6, time);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
            noise.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(output);
            noise.start(time);
            noise.stop(time + 0.2);
        }

        function playHiHat(time, output, velocity, open) {
            const duration = open ? 0.4 : 0.08;

            // Multiple oscillators for metallic sound
            for (let i = 0; i < 6; i++) {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                const filter = audioCtx.createBiquadFilter();

                osc.type = 'square';
                osc.frequency.value = 300 * (i + 1) * 1.4;

                filter.type = 'highpass';
                filter.frequency.value = 7000;

                gain.gain.setValueAtTime(velocity * 0.15, time);
                gain.gain.exponentialRampToValueAtTime(0.001, time + duration);

                osc.connect(filter);
                filter.connect(gain);
                gain.connect(output);

                osc.start(time);
                osc.stop(time + duration);
            }
        }

        function playClap(time, output, velocity) {
            for (let i = 0; i < 3; i++) {
                const noise = createNoise(0.1);
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.frequency.value = 1200;
                filter.Q.value = 1;
                const gain = audioCtx.createGain();

                const offset = i * 0.01;
                gain.gain.setValueAtTime(0, time + offset);
                gain.gain.linearRampToValueAtTime(velocity * 0.5, time + offset + 0.005);
                gain.gain.exponentialRampToValueAtTime(0.001, time + offset + 0.1);

                noise.connect(filter);
                filter.connect(gain);
                gain.connect(output);
                noise.start(time + offset);
                noise.stop(time + offset + 0.1);
            }
        }

        function playTom(time, output, velocity) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'sine';
            osc.frequency.setValueAtTime(200, time);
            osc.frequency.exponentialRampToValueAtTime(80, time + 0.2);

            gain.gain.setValueAtTime(velocity * 0.8, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.3);

            osc.connect(gain);
            gain.connect(output);
            osc.start(time);
            osc.stop(time + 0.3);
        }

        function playRim(time, output, velocity) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.type = 'triangle';
            osc.frequency.setValueAtTime(800, time);

            gain.gain.setValueAtTime(velocity * 0.4, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05);

            osc.connect(gain);
            gain.connect(output);
            osc.start(time);
            osc.stop(time + 0.05);
        }

        function playCymbal(time, output, velocity) {
            const noise = createNoise(1);
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'highpass';
            filter.frequency.value = 5000;
            const gain = audioCtx.createGain();

            gain.gain.setValueAtTime(velocity * 0.3, time);
            gain.gain.exponentialRampToValueAtTime(0.001, time + 1);

            noise.connect(filter);
            filter.connect(gain);
            gain.connect(output);
            noise.start(time);
            noise.stop(time + 1);
        }

        function createNoise(duration) {
            const bufferSize = audioCtx.sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);

            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const source = audioCtx.createBufferSource();
            source.buffer = buffer;
            return source;
        }

        // Sequencer
        function scheduler() {
            while (nextNoteTime < audioCtx.currentTime + SCHEDULE_AHEAD) {
                scheduleStep(currentStep, nextNoteTime);
                advanceNote();
            }
        }

        function scheduleStep(step, time) {
            const pattern = patterns[currentPattern];
            const hasSolo = soloed.some(s => s);

            tracks.forEach((track, trackIndex) => {
                if (pattern[trackIndex][step]) {
                    // Check mute/solo
                    if (muted[trackIndex]) return;
                    if (hasSolo && !soloed[trackIndex]) return;

                    playSound(trackIndex, time, pattern[trackIndex][step]);
                }
            });

            // Update UI on the main thread
            setTimeout(() => {
                updateStepIndicator(step);
            }, (time - audioCtx.currentTime) * 1000);
        }

        function advanceNote() {
            const secondsPerBeat = 60.0 / tempo;
            const secondsPerStep = secondsPerBeat / 4;

            // Apply swing to even steps
            let swingOffset = 0;
            if (currentStep % 2 === 1 && swing > 0) {
                swingOffset = secondsPerStep * (swing / 100) * 0.5;
            }

            nextNoteTime += secondsPerStep + swingOffset;
            currentStep = (currentStep + 1) % STEPS;
        }

        function updateStepIndicator(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('current'));
            document.querySelectorAll(`.step[data-step="${step}"]`).forEach(s => {
                s.classList.add('current');
            });
        }

        function startSequencer() {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            isPlaying = true;
            currentStep = 0;
            nextNoteTime = audioCtx.currentTime;
            schedulerTimer = setInterval(scheduler, LOOKAHEAD);

            document.getElementById('playBtn').classList.add('playing');
            document.getElementById('playBtn').innerHTML = '&#10074;&#10074;';
        }

        function stopSequencer() {
            isPlaying = false;
            clearInterval(schedulerTimer);
            currentStep = 0;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('current'));

            document.getElementById('playBtn').classList.remove('playing');
            document.getElementById('playBtn').innerHTML = '&#9658;';
        }

        // Build UI
        function buildSequencer() {
            const container = document.getElementById('sequencer');
            container.innerHTML = '';

            tracks.forEach((track, trackIndex) => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track';

                const infoEl = document.createElement('div');
                infoEl.className = 'track-info';

                const nameEl = document.createElement('span');
                nameEl.className = 'track-name';
                nameEl.textContent = track.name;
                nameEl.style.color = track.color;

                const controlsEl = document.createElement('div');
                controlsEl.className = 'track-controls';

                const muteBtn = document.createElement('button');
                muteBtn.className = 'track-btn mute-btn';
                muteBtn.textContent = 'M';
                muteBtn.addEventListener('click', () => {
                    muted[trackIndex] = !muted[trackIndex];
                    muteBtn.classList.toggle('active');
                });

                const soloBtn = document.createElement('button');
                soloBtn.className = 'track-btn solo-btn';
                soloBtn.textContent = 'S';
                soloBtn.addEventListener('click', () => {
                    soloed[trackIndex] = !soloed[trackIndex];
                    soloBtn.classList.toggle('active');
                });

                controlsEl.appendChild(muteBtn);
                controlsEl.appendChild(soloBtn);

                infoEl.appendChild(nameEl);
                infoEl.appendChild(controlsEl);

                const stepsEl = document.createElement('div');
                stepsEl.className = 'steps';

                for (let step = 0; step < STEPS; step++) {
                    const stepEl = document.createElement('button');
                    stepEl.className = 'step';
                    stepEl.style.setProperty('--track-color', track.color);
                    stepEl.dataset.track = trackIndex;
                    stepEl.dataset.step = step;

                    if (patterns[currentPattern][trackIndex][step]) {
                        stepEl.classList.add('active');
                    }

                    stepEl.addEventListener('click', (e) => {
                        toggleStep(trackIndex, step, e.shiftKey);
                    });

                    stepEl.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        cycleVelocity(trackIndex, step);
                    });

                    stepsEl.appendChild(stepEl);
                }

                trackEl.appendChild(infoEl);
                trackEl.appendChild(stepsEl);
                container.appendChild(trackEl);
            });
        }

        function toggleStep(track, step, fill = false) {
            if (!audioCtx) initAudio();

            if (fill) {
                // Fill from this step to the end
                const value = patterns[currentPattern][track][step] ? 0 : 1;
                for (let s = step; s < STEPS; s++) {
                    patterns[currentPattern][track][s] = value;
                }
            } else {
                patterns[currentPattern][track][step] =
                    patterns[currentPattern][track][step] ? 0 : 1;
            }

            updateStepUI();

            // Play sound preview
            if (patterns[currentPattern][track][step] && !isPlaying) {
                playSound(track, audioCtx.currentTime, 1);
            }
        }

        function cycleVelocity(track, step) {
            const current = patterns[currentPattern][track][step];
            if (current === 0) {
                patterns[currentPattern][track][step] = 1;
            } else if (current === 1) {
                patterns[currentPattern][track][step] = 0.5;
            } else if (current === 0.5) {
                patterns[currentPattern][track][step] = 0.75;
            } else {
                patterns[currentPattern][track][step] = 0;
            }
            updateStepUI();
        }

        function updateStepUI() {
            document.querySelectorAll('.step').forEach(stepEl => {
                const track = parseInt(stepEl.dataset.track);
                const step = parseInt(stepEl.dataset.step);
                const value = patterns[currentPattern][track][step];

                stepEl.classList.remove('active', 'velocity-low', 'velocity-med', 'velocity-high');

                if (value) {
                    stepEl.classList.add('active');
                    if (value <= 0.5) stepEl.classList.add('velocity-low');
                    else if (value <= 0.75) stepEl.classList.add('velocity-med');
                    else stepEl.classList.add('velocity-high');
                }
            });
        }

        function buildPads() {
            const container = document.getElementById('pads');
            container.innerHTML = '';

            tracks.forEach((track, index) => {
                const pad = document.createElement('button');
                pad.className = 'pad';
                pad.style.background = track.color;
                pad.innerHTML = `${track.name}<span class="key">${track.key}</span>`;

                pad.addEventListener('mousedown', () => {
                    triggerPad(index);
                    pad.classList.add('playing');
                });

                pad.addEventListener('mouseup', () => {
                    pad.classList.remove('playing');
                });

                pad.addEventListener('mouseleave', () => {
                    pad.classList.remove('playing');
                });

                container.appendChild(pad);
            });
        }

        function triggerPad(index) {
            if (!audioCtx) initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            playSound(index, audioCtx.currentTime, 1);
        }

        // Visualizer
        function drawVisualizer() {
            const canvas = document.getElementById('visualizer');
            const ctx = canvas.getContext('2d');

            canvas.width = canvas.offsetWidth * 2;
            canvas.height = canvas.offsetHeight * 2;

            function draw() {
                if (!analyser) {
                    requestAnimationFrame(draw);
                    return;
                }

                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                analyser.getByteFrequencyData(dataArray);

                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                const barWidth = canvas.width / bufferLength * 2.5;
                let x = 0;

                for (let i = 0; i < bufferLength; i++) {
                    const barHeight = (dataArray[i] / 255) * canvas.height;

                    const hue = (i / bufferLength) * 60 + 350;
                    ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);

                    x += barWidth + 1;
                }

                requestAnimationFrame(draw);
            }

            draw();
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('playBtn').addEventListener('click', () => {
                if (isPlaying) {
                    stopSequencer();
                } else {
                    startSequencer();
                }
            });

            document.getElementById('stopBtn').addEventListener('click', stopSequencer);

            document.getElementById('tempoSlider').addEventListener('input', (e) => {
                tempo = parseInt(e.target.value);
                document.getElementById('tempoDisplay').textContent = tempo;
            });

            document.getElementById('tempoUp').addEventListener('click', () => {
                tempo = Math.min(200, tempo + 1);
                document.getElementById('tempoSlider').value = tempo;
                document.getElementById('tempoDisplay').textContent = tempo;
            });

            document.getElementById('tempoDown').addEventListener('click', () => {
                tempo = Math.max(60, tempo - 1);
                document.getElementById('tempoSlider').value = tempo;
                document.getElementById('tempoDisplay').textContent = tempo;
            });

            document.getElementById('swingSlider').addEventListener('input', (e) => {
                swing = parseInt(e.target.value);
                document.getElementById('swingValue').textContent = swing + '%';
            });

            document.getElementById('volumeSlider').addEventListener('input', (e) => {
                volume = parseInt(e.target.value) / 100;
                document.getElementById('volumeValue').textContent = e.target.value + '%';
                if (masterGain) masterGain.gain.value = volume;
            });

            // Kit selector
            document.querySelectorAll('.kit-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentKit = btn.dataset.kit;
                    document.querySelectorAll('.kit-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Pattern selector
            document.querySelectorAll('.pattern-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentPattern = parseInt(btn.dataset.pattern);
                    document.querySelectorAll('.pattern-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateStepUI();
                });
            });

            // Pattern actions
            document.getElementById('clearPattern').addEventListener('click', () => {
                patterns[currentPattern] = tracks.map(() => Array(STEPS).fill(0));
                updateStepUI();
            });

            document.getElementById('copyPattern').addEventListener('click', () => {
                copiedPattern = JSON.parse(JSON.stringify(patterns[currentPattern]));
            });

            document.getElementById('pastePattern').addEventListener('click', () => {
                if (copiedPattern) {
                    patterns[currentPattern] = JSON.parse(JSON.stringify(copiedPattern));
                    updateStepUI();
                }
            });

            document.getElementById('randomPattern').addEventListener('click', () => {
                tracks.forEach((_, trackIndex) => {
                    for (let step = 0; step < STEPS; step++) {
                        // Higher probability for kick on 1 and 9, snare on 5 and 13
                        let prob = 0.2;
                        if (trackIndex === 0 && (step === 0 || step === 8)) prob = 0.9;
                        if (trackIndex === 1 && (step === 4 || step === 12)) prob = 0.9;
                        if (trackIndex === 2) prob = 0.5;

                        patterns[currentPattern][trackIndex][step] = Math.random() < prob ? 1 : 0;
                    }
                });
                updateStepUI();
            });

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if (e.repeat) return;

                const key = e.key;
                const trackIndex = tracks.findIndex(t => t.key === key);

                if (trackIndex !== -1) {
                    triggerPad(trackIndex);
                    document.querySelectorAll('.pad')[trackIndex].classList.add('playing');
                }

                if (key === ' ') {
                    e.preventDefault();
                    if (isPlaying) stopSequencer();
                    else startSequencer();
                }
            });

            document.addEventListener('keyup', (e) => {
                const key = e.key;
                const trackIndex = tracks.findIndex(t => t.key === key);

                if (trackIndex !== -1) {
                    document.querySelectorAll('.pad')[trackIndex].classList.remove('playing');
                }
            });
        }

        // Initialize
        function init() {
            buildSequencer();
            buildPads();
            setupEventListeners();
            drawVisualizer();
        }

        init();
    </script>
</body>
</html>
