<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pendulum Physics Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: 100vh;
        }

        .controls {
            background: rgba(20, 20, 35, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 20px;
            overflow-y: auto;
        }

        h1 {
            font-size: 1.5em;
            background: linear-gradient(135deg, #f97316 0%, #eab308 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            margin-bottom: 25px;
        }

        .control-section {
            margin-bottom: 25px;
        }

        .control-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #f97316;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mode-btns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 15px;
        }

        .mode-btn {
            padding: 10px 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 11px;
            text-align: center;
        }

        .mode-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.3), rgba(234, 179, 8, 0.3));
            border-color: #f97316;
        }

        .slider-group {
            margin-bottom: 15px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .slider-value {
            color: #eab308;
            font-weight: 600;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: linear-gradient(135deg, #f97316, #eab308);
            border-radius: 50%;
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 13px;
        }

        input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: #f97316;
        }

        button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #f97316, #eab308);
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(249, 115, 22, 0.3);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: none;
        }

        .canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 13px;
            min-width: 160px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.6);
        }

        .info-value {
            color: #eab308;
            font-weight: 600;
        }

        .formula-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            font-family: 'Times New Roman', serif;
            font-size: 14px;
        }

        .formula-title {
            color: #f97316;
            margin-bottom: 10px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .formula {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .presets {
            display: grid;
            gap: 6px;
        }

        .preset-btn {
            padding: 8px;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }

            .controls {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 200px;
                border-right: none;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <h1>Pendulum Physics</h1>
            <p class="subtitle">From simple harmonic motion to chaos</p>

            <div class="control-section">
                <h3>Pendulum Type</h3>
                <div class="mode-btns">
                    <button class="mode-btn active" data-mode="single">Single</button>
                    <button class="mode-btn" data-mode="double">Double</button>
                    <button class="mode-btn" data-mode="triple">Triple</button>
                </div>
            </div>

            <div class="control-section">
                <h3>Physics Parameters</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Gravity (g)</span>
                        <span class="slider-value" id="gravityValue">9.81</span>
                    </div>
                    <input type="range" id="gravity" min="1" max="20" step="0.1" value="9.81">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Length 1</span>
                        <span class="slider-value" id="length1Value">150</span>
                    </div>
                    <input type="range" id="length1" min="50" max="250" value="150">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Length 2</span>
                        <span class="slider-value" id="length2Value">120</span>
                    </div>
                    <input type="range" id="length2" min="50" max="200" value="120">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Length 3</span>
                        <span class="slider-value" id="length3Value">100</span>
                    </div>
                    <input type="range" id="length3" min="30" max="150" value="100">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Mass 1</span>
                        <span class="slider-value" id="mass1Value">10</span>
                    </div>
                    <input type="range" id="mass1" min="1" max="30" value="10">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Mass 2</span>
                        <span class="slider-value" id="mass2Value">10</span>
                    </div>
                    <input type="range" id="mass2" min="1" max="30" value="10">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Mass 3</span>
                        <span class="slider-value" id="mass3Value">8</span>
                    </div>
                    <input type="range" id="mass3" min="1" max="25" value="8">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Damping</span>
                        <span class="slider-value" id="dampingValue">0.000</span>
                    </div>
                    <input type="range" id="damping" min="0" max="0.05" step="0.001" value="0">
                </div>
            </div>

            <div class="control-section">
                <h3>Initial Conditions</h3>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Angle 1 (deg)</span>
                        <span class="slider-value" id="angle1Value">120</span>
                    </div>
                    <input type="range" id="angle1" min="-180" max="180" value="120">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Angle 2 (deg)</span>
                        <span class="slider-value" id="angle2Value">120</span>
                    </div>
                    <input type="range" id="angle2" min="-180" max="180" value="120">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Angle 3 (deg)</span>
                        <span class="slider-value" id="angle3Value">90</span>
                    </div>
                    <input type="range" id="angle3" min="-180" max="180" value="90">
                </div>
            </div>

            <div class="control-section">
                <h3>Display Options</h3>
                <div class="checkbox-group">
                    <input type="checkbox" id="showTrail" checked>
                    <label for="showTrail">Show Trail</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="showVelocity">
                    <label for="showVelocity">Show Velocity Vectors</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="showEnergy">
                    <label for="showEnergy">Show Energy Bar</label>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>Trail Length</span>
                        <span class="slider-value" id="trailLengthValue">500</span>
                    </div>
                    <input type="range" id="trailLength" min="100" max="2000" value="500">
                </div>
            </div>

            <div class="control-section">
                <h3>Controls</h3>
                <button onclick="toggleSimulation()">Pause / Resume</button>
                <button onclick="resetSimulation()" class="btn-secondary">Reset</button>
            </div>

            <div class="control-section">
                <h3>Presets</h3>
                <div class="presets">
                    <button onclick="loadPreset('chaos')" class="btn-secondary preset-btn">Chaotic Double</button>
                    <button onclick="loadPreset('sync')" class="btn-secondary preset-btn">Synchronized</button>
                    <button onclick="loadPreset('heavy')" class="btn-secondary preset-btn">Heavy Bottom</button>
                    <button onclick="loadPreset('light')" class="btn-secondary preset-btn">Light Top</button>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <canvas id="canvas"></canvas>
            <div class="info-panel">
                <div class="info-row">
                    <span class="info-label">Time:</span>
                    <span class="info-value" id="timeValue">0.00s</span>
                </div>
                <div class="info-row">
                    <span class="info-label">KE:</span>
                    <span class="info-value" id="keValue">0.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">PE:</span>
                    <span class="info-value" id="peValue">0.00</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total E:</span>
                    <span class="info-value" id="totalEValue">0.00</span>
                </div>
            </div>
            <div class="formula-panel" id="formulaPanel">
                <div class="formula-title">Equations of Motion</div>
                <div class="formula" id="formula1"></div>
                <div class="formula" id="formula2"></div>
            </div>
            <div class="legend" id="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #f97316;"></div>
                    <span>Bob 1</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #22d3ee;"></div>
                    <span>Bob 2</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #a855f7;"></div>
                    <span>Bob 3</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        // State
        let mode = 'single';
        let isRunning = true;
        let time = 0;
        let trail1 = [];
        let trail2 = [];
        let trail3 = [];

        // Physics parameters
        let g = 9.81;
        let L1 = 150, L2 = 120, L3 = 100;
        let m1 = 10, m2 = 10, m3 = 8;
        let damping = 0;

        // State variables (angles and angular velocities)
        let theta1, theta2, theta3;
        let omega1, omega2, omega3;

        // Colors
        const COLORS = {
            bob1: '#f97316',
            bob2: '#22d3ee',
            bob3: '#a855f7',
            rod: 'rgba(255, 255, 255, 0.6)',
            trail1: 'rgba(249, 115, 22, 0.5)',
            trail2: 'rgba(34, 211, 238, 0.5)',
            trail3: 'rgba(168, 85, 247, 0.5)',
            pivot: '#fff'
        };

        // Initialize
        function init() {
            resizeCanvas();
            updateSliderValues();
            resetSimulation();
            animate();
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth * window.devicePixelRatio;
            canvas.height = canvas.offsetHeight * window.devicePixelRatio;
            ctx.scale(window.devicePixelRatio, window.devicePixelRatio);
        }

        window.addEventListener('resize', resizeCanvas);

        // Slider value displays
        function updateSliderValues() {
            const sliders = ['gravity', 'length1', 'length2', 'length3', 'mass1', 'mass2', 'mass3', 'damping', 'angle1', 'angle2', 'angle3', 'trailLength'];

            sliders.forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');

                if (slider && valueSpan) {
                    slider.addEventListener('input', () => {
                        let val = parseFloat(slider.value);
                        if (id === 'damping') {
                            valueSpan.textContent = val.toFixed(3);
                        } else {
                            valueSpan.textContent = val;
                        }
                        updateParameters();
                    });
                }
            });
        }

        function updateParameters() {
            g = parseFloat(document.getElementById('gravity').value);
            L1 = parseFloat(document.getElementById('length1').value);
            L2 = parseFloat(document.getElementById('length2').value);
            L3 = parseFloat(document.getElementById('length3').value);
            m1 = parseFloat(document.getElementById('mass1').value);
            m2 = parseFloat(document.getElementById('mass2').value);
            m3 = parseFloat(document.getElementById('mass3').value);
            damping = parseFloat(document.getElementById('damping').value);
        }

        function resetSimulation() {
            updateParameters();

            theta1 = parseFloat(document.getElementById('angle1').value) * Math.PI / 180;
            theta2 = parseFloat(document.getElementById('angle2').value) * Math.PI / 180;
            theta3 = parseFloat(document.getElementById('angle3').value) * Math.PI / 180;
            omega1 = 0;
            omega2 = 0;
            omega3 = 0;

            trail1 = [];
            trail2 = [];
            trail3 = [];
            time = 0;

            updateFormulas();
        }

        function toggleSimulation() {
            isRunning = !isRunning;
        }

        // Mode buttons
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                mode = btn.dataset.mode;
                updateFormulas();
                updateLegend();
                resetSimulation();
            });
        });

        function updateLegend() {
            const legend = document.getElementById('legend');
            if (mode === 'single') {
                legend.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f97316;"></div>
                        <span>Bob</span>
                    </div>
                `;
            } else if (mode === 'double') {
                legend.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f97316;"></div>
                        <span>Bob 1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22d3ee;"></div>
                        <span>Bob 2</span>
                    </div>
                `;
            } else {
                legend.innerHTML = `
                    <div class="legend-item">
                        <div class="legend-color" style="background: #f97316;"></div>
                        <span>Bob 1</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #22d3ee;"></div>
                        <span>Bob 2</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #a855f7;"></div>
                        <span>Bob 3</span>
                    </div>
                `;
            }
        }

        function updateFormulas() {
            const f1 = document.getElementById('formula1');
            const f2 = document.getElementById('formula2');

            if (mode === 'single') {
                f1.textContent = 'θ\'\' = -(g/L) sin(θ)';
                f2.textContent = 'Period T = 2π√(L/g)';
            } else if (mode === 'double') {
                f1.textContent = 'θ₁\'\' = f(θ₁, θ₂, θ₁\', θ₂\', m₁, m₂, L₁, L₂, g)';
                f2.textContent = 'θ₂\'\' = f(θ₁, θ₂, θ₁\', θ₂\', m₁, m₂, L₁, L₂, g)';
            } else {
                f1.textContent = 'Triple pendulum: highly chaotic';
                f2.textContent = 'Lagrangian mechanics required';
            }
        }

        // Physics simulation
        function simulateSingle(dt) {
            // Simple pendulum: θ'' = -(g/L) sin(θ) - damping * θ'
            const alpha = -(g / L1) * Math.sin(theta1) - damping * omega1;
            omega1 += alpha * dt;
            theta1 += omega1 * dt;
        }

        function simulateDouble(dt) {
            // Double pendulum using Lagrangian mechanics
            const M = m1 + m2;
            const d = theta1 - theta2;

            // Equations of motion (derived from Lagrangian)
            const num1 = -g * (2 * m1 + m2) * Math.sin(theta1)
                       - m2 * g * Math.sin(theta1 - 2 * theta2)
                       - 2 * Math.sin(d) * m2 * (omega2 * omega2 * L2 + omega1 * omega1 * L1 * Math.cos(d));
            const den1 = L1 * (2 * m1 + m2 - m2 * Math.cos(2 * d));

            const num2 = 2 * Math.sin(d) * (omega1 * omega1 * L1 * M
                       + g * M * Math.cos(theta1)
                       + omega2 * omega2 * L2 * m2 * Math.cos(d));
            const den2 = L2 * (2 * m1 + m2 - m2 * Math.cos(2 * d));

            const alpha1 = num1 / den1 - damping * omega1;
            const alpha2 = num2 / den2 - damping * omega2;

            omega1 += alpha1 * dt;
            omega2 += alpha2 * dt;
            theta1 += omega1 * dt;
            theta2 += omega2 * dt;
        }

        function simulateTriple(dt) {
            // Triple pendulum - simplified approximation
            // Full Lagrangian is extremely complex, using coupled oscillator approximation

            const d12 = theta1 - theta2;
            const d23 = theta2 - theta3;
            const M = m1 + m2 + m3;

            // Approximate coupled equations
            const alpha1 = -(g / L1) * (M / m1) * Math.sin(theta1)
                         + (m2 + m3) / m1 * omega2 * omega2 * Math.sin(d12) / L1 * L2
                         - damping * omega1;

            const alpha2 = -(g / L2) * Math.sin(theta2)
                         - omega1 * omega1 * Math.sin(d12) * L1 / L2
                         + (m3 / m2) * omega3 * omega3 * Math.sin(d23) * L3 / L2
                         - damping * omega2;

            const alpha3 = -(g / L3) * Math.sin(theta3)
                         - omega2 * omega2 * Math.sin(d23) * L2 / L3
                         - damping * omega3;

            omega1 += alpha1 * dt;
            omega2 += alpha2 * dt;
            omega3 += alpha3 * dt;
            theta1 += omega1 * dt;
            theta2 += omega2 * dt;
            theta3 += omega3 * dt;
        }

        function calculateEnergy() {
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            const cx = width / 2;
            const cy = height / 2 - 50;

            let KE = 0, PE = 0;

            if (mode === 'single') {
                const v1 = L1 * omega1;
                KE = 0.5 * m1 * v1 * v1;
                PE = m1 * g * L1 * (1 - Math.cos(theta1));
            } else if (mode === 'double') {
                const x1 = L1 * Math.sin(theta1);
                const y1 = L1 * Math.cos(theta1);
                const x2 = x1 + L2 * Math.sin(theta2);
                const y2 = y1 + L2 * Math.cos(theta2);

                const vx1 = L1 * omega1 * Math.cos(theta1);
                const vy1 = -L1 * omega1 * Math.sin(theta1);
                const vx2 = vx1 + L2 * omega2 * Math.cos(theta2);
                const vy2 = vy1 - L2 * omega2 * Math.sin(theta2);

                KE = 0.5 * m1 * (vx1 * vx1 + vy1 * vy1) + 0.5 * m2 * (vx2 * vx2 + vy2 * vy2);
                PE = m1 * g * (L1 - y1) + m2 * g * (L1 + L2 - y2);
            } else {
                // Triple pendulum energy
                const x1 = L1 * Math.sin(theta1);
                const y1 = L1 * Math.cos(theta1);
                const x2 = x1 + L2 * Math.sin(theta2);
                const y2 = y1 + L2 * Math.cos(theta2);
                const x3 = x2 + L3 * Math.sin(theta3);
                const y3 = y2 + L3 * Math.cos(theta3);

                const vx1 = L1 * omega1 * Math.cos(theta1);
                const vy1 = -L1 * omega1 * Math.sin(theta1);
                const vx2 = vx1 + L2 * omega2 * Math.cos(theta2);
                const vy2 = vy1 - L2 * omega2 * Math.sin(theta2);
                const vx3 = vx2 + L3 * omega3 * Math.cos(theta3);
                const vy3 = vy2 - L3 * omega3 * Math.sin(theta3);

                KE = 0.5 * m1 * (vx1 * vx1 + vy1 * vy1) +
                     0.5 * m2 * (vx2 * vx2 + vy2 * vy2) +
                     0.5 * m3 * (vx3 * vx3 + vy3 * vy3);
                PE = m1 * g * (L1 - y1) + m2 * g * (L1 + L2 - y2) + m3 * g * (L1 + L2 + L3 - y3);
            }

            return { KE, PE, total: KE + PE };
        }

        // Drawing
        function draw() {
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;

            ctx.clearRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2 - 50;

            // Calculate bob positions
            const x1 = cx + L1 * Math.sin(theta1);
            const y1 = cy + L1 * Math.cos(theta1);

            let x2, y2, x3, y3;

            if (mode === 'double' || mode === 'triple') {
                x2 = x1 + L2 * Math.sin(theta2);
                y2 = y1 + L2 * Math.cos(theta2);
            }

            if (mode === 'triple') {
                x3 = x2 + L3 * Math.sin(theta3);
                y3 = y2 + L3 * Math.cos(theta3);
            }

            // Update trails
            const showTrail = document.getElementById('showTrail').checked;
            const trailLength = parseInt(document.getElementById('trailLength').value);

            if (showTrail) {
                if (mode === 'single') {
                    trail1.push({ x: x1, y: y1 });
                    if (trail1.length > trailLength) trail1.shift();
                } else if (mode === 'double') {
                    trail2.push({ x: x2, y: y2 });
                    if (trail2.length > trailLength) trail2.shift();
                } else {
                    trail3.push({ x: x3, y: y3 });
                    if (trail3.length > trailLength) trail3.shift();
                }
            }

            // Draw trails
            if (showTrail) {
                if (mode === 'single') {
                    drawTrail(trail1, COLORS.trail1);
                } else if (mode === 'double') {
                    drawTrail(trail2, COLORS.trail2);
                } else {
                    drawTrail(trail3, COLORS.trail3);
                }
            }

            // Draw rods
            ctx.strokeStyle = COLORS.rod;
            ctx.lineWidth = 3;

            // Rod 1
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.lineTo(x1, y1);
            ctx.stroke();

            if (mode === 'double' || mode === 'triple') {
                // Rod 2
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

            if (mode === 'triple') {
                // Rod 3
                ctx.beginPath();
                ctx.moveTo(x2, y2);
                ctx.lineTo(x3, y3);
                ctx.stroke();
            }

            // Draw velocity vectors
            const showVelocity = document.getElementById('showVelocity').checked;
            if (showVelocity) {
                const scale = 5;

                // Velocity of bob 1
                const vx1 = L1 * omega1 * Math.cos(theta1) * scale;
                const vy1 = -L1 * omega1 * Math.sin(theta1) * scale;
                drawArrow(x1, y1, x1 + vx1, y1 + vy1, COLORS.bob1);

                if (mode === 'double' || mode === 'triple') {
                    const vx2 = (L1 * omega1 * Math.cos(theta1) + L2 * omega2 * Math.cos(theta2)) * scale;
                    const vy2 = (-L1 * omega1 * Math.sin(theta1) - L2 * omega2 * Math.sin(theta2)) * scale;
                    drawArrow(x2, y2, x2 + vx2, y2 + vy2, COLORS.bob2);
                }

                if (mode === 'triple') {
                    const vx3 = (L1 * omega1 * Math.cos(theta1) + L2 * omega2 * Math.cos(theta2) + L3 * omega3 * Math.cos(theta3)) * scale;
                    const vy3 = (-L1 * omega1 * Math.sin(theta1) - L2 * omega2 * Math.sin(theta2) - L3 * omega3 * Math.sin(theta3)) * scale;
                    drawArrow(x3, y3, x3 + vx3, y3 + vy3, COLORS.bob3);
                }
            }

            // Draw pivot
            ctx.beginPath();
            ctx.arc(cx, cy, 8, 0, Math.PI * 2);
            ctx.fillStyle = COLORS.pivot;
            ctx.fill();

            // Draw bobs
            const r1 = 10 + m1 * 0.5;
            ctx.beginPath();
            ctx.arc(x1, y1, r1, 0, Math.PI * 2);
            ctx.fillStyle = COLORS.bob1;
            ctx.fill();
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();

            if (mode === 'double' || mode === 'triple') {
                const r2 = 10 + m2 * 0.5;
                ctx.beginPath();
                ctx.arc(x2, y2, r2, 0, Math.PI * 2);
                ctx.fillStyle = COLORS.bob2;
                ctx.fill();
                ctx.stroke();
            }

            if (mode === 'triple') {
                const r3 = 10 + m3 * 0.5;
                ctx.beginPath();
                ctx.arc(x3, y3, r3, 0, Math.PI * 2);
                ctx.fillStyle = COLORS.bob3;
                ctx.fill();
                ctx.stroke();
            }

            // Draw energy bar
            const showEnergy = document.getElementById('showEnergy').checked;
            if (showEnergy) {
                const energy = calculateEnergy();
                const barWidth = 200;
                const barHeight = 20;
                const barX = width - barWidth - 30;
                const barY = height - 60;

                // Background
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(barX, barY, barWidth, barHeight);

                // KE portion
                const keRatio = energy.KE / energy.total;
                ctx.fillStyle = '#f97316';
                ctx.fillRect(barX, barY, barWidth * keRatio, barHeight);

                // PE portion
                ctx.fillStyle = '#22d3ee';
                ctx.fillRect(barX + barWidth * keRatio, barY, barWidth * (1 - keRatio), barHeight);

                // Labels
                ctx.fillStyle = '#fff';
                ctx.font = '11px Segoe UI';
                ctx.textAlign = 'left';
                ctx.fillText('KE', barX + 5, barY + 14);
                ctx.textAlign = 'right';
                ctx.fillText('PE', barX + barWidth - 5, barY + 14);
            }

            // Update info panel
            const energy = calculateEnergy();
            document.getElementById('timeValue').textContent = time.toFixed(2) + 's';
            document.getElementById('keValue').textContent = (energy.KE / 1000).toFixed(2);
            document.getElementById('peValue').textContent = (energy.PE / 1000).toFixed(2);
            document.getElementById('totalEValue').textContent = (energy.total / 1000).toFixed(2);
        }

        function drawTrail(trail, color) {
            if (trail.length < 2) return;

            ctx.beginPath();
            ctx.moveTo(trail[0].x, trail[0].y);

            for (let i = 1; i < trail.length; i++) {
                ctx.lineTo(trail[i].x, trail[i].y);
            }

            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        function drawArrow(x1, y1, x2, y2, color) {
            const headLen = 10;
            const angle = Math.atan2(y2 - y1, x2 - x1);

            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Arrowhead
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headLen * Math.cos(angle - Math.PI / 6), y2 - headLen * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headLen * Math.cos(angle + Math.PI / 6), y2 - headLen * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fillStyle = color;
            ctx.fill();
        }

        // Animation loop
        function animate() {
            if (isRunning) {
                const dt = 0.016; // 60 FPS timestep
                const substeps = 4; // Higher accuracy

                for (let i = 0; i < substeps; i++) {
                    if (mode === 'single') {
                        simulateSingle(dt / substeps);
                    } else if (mode === 'double') {
                        simulateDouble(dt / substeps);
                    } else {
                        simulateTriple(dt / substeps);
                    }
                }

                time += dt;
            }

            draw();
            requestAnimationFrame(animate);
        }

        // Presets
        function loadPreset(preset) {
            switch (preset) {
                case 'chaos':
                    mode = 'double';
                    document.getElementById('angle1').value = 170;
                    document.getElementById('angle2').value = 170;
                    document.getElementById('length1').value = 150;
                    document.getElementById('length2').value = 150;
                    document.getElementById('mass1').value = 10;
                    document.getElementById('mass2').value = 10;
                    document.getElementById('damping').value = 0;
                    break;
                case 'sync':
                    mode = 'double';
                    document.getElementById('angle1').value = 45;
                    document.getElementById('angle2').value = 45;
                    document.getElementById('length1').value = 150;
                    document.getElementById('length2').value = 150;
                    document.getElementById('mass1').value = 10;
                    document.getElementById('mass2').value = 10;
                    break;
                case 'heavy':
                    mode = 'double';
                    document.getElementById('angle1').value = 90;
                    document.getElementById('angle2').value = 90;
                    document.getElementById('mass1').value = 5;
                    document.getElementById('mass2').value = 25;
                    break;
                case 'light':
                    mode = 'double';
                    document.getElementById('angle1').value = 120;
                    document.getElementById('angle2').value = 60;
                    document.getElementById('mass1').value = 25;
                    document.getElementById('mass2').value = 5;
                    break;
            }

            // Update UI
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Update slider displays
            ['gravity', 'length1', 'length2', 'length3', 'mass1', 'mass2', 'mass3', 'damping', 'angle1', 'angle2', 'angle3'].forEach(id => {
                const slider = document.getElementById(id);
                const valueSpan = document.getElementById(id + 'Value');
                if (slider && valueSpan) {
                    let val = parseFloat(slider.value);
                    valueSpan.textContent = id === 'damping' ? val.toFixed(3) : val;
                }
            });

            updateFormulas();
            updateLegend();
            resetSimulation();
        }

        // Mouse interaction - drag to set angle
        let isDragging = false;
        let dragBob = 0;

        canvas.addEventListener('mousedown', e => {
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            const cx = canvas.offsetWidth / 2;
            const cy = canvas.offsetHeight / 2 - 50;

            const x1 = cx + L1 * Math.sin(theta1);
            const y1 = cy + L1 * Math.cos(theta1);

            const dist1 = Math.sqrt((mx - x1) ** 2 + (my - y1) ** 2);

            if (dist1 < 30) {
                isDragging = true;
                dragBob = 1;
                isRunning = false;
            }
        });

        canvas.addEventListener('mousemove', e => {
            if (!isDragging) return;

            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const my = e.clientY - rect.top;

            const cx = canvas.offsetWidth / 2;
            const cy = canvas.offsetHeight / 2 - 50;

            theta1 = Math.atan2(mx - cx, my - cy);
            omega1 = 0;
            omega2 = 0;
            omega3 = 0;

            document.getElementById('angle1').value = Math.round(theta1 * 180 / Math.PI);
            document.getElementById('angle1Value').textContent = Math.round(theta1 * 180 / Math.PI);

            draw();
        });

        canvas.addEventListener('mouseup', () => {
            if (isDragging) {
                isDragging = false;
                isRunning = true;
                trail1 = [];
                trail2 = [];
                trail3 = [];
            }
        });

        // Start
        init();
    </script>
</body>
</html>
